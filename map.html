<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bản đồ và Quản lý Cây Trồng</title>

    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

    <style>
      /* --- CSS MỚI CHO BỐ CỤC Top-Bottom --- */
      html,
      body {
        margin: 0;
        padding: 0;
        font-family: Arial, sans-serif;
        height: 100vh;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      #scanner-panel {
        flex-shrink: 0;
        padding: 1rem; /* Giảm padding tổng của panel */
        background-color: white;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        overflow-y: auto;
        max-height: 45vh; /* Giữ nguyên 40% */
      }

      #map-container {
        flex-grow: 1;
        min-height: 55vh; /* Giữ nguyên 60% */
      }

      #map {
        height: 100%;
        width: 100%;
      }

      /* --- CSS CHO FORM (ĐÃ ĐIỀU CHỈNH) --- */
      .info-label {
        display: block;
        /* === THAY ĐỔI: Giảm cỡ chữ label === */
        font-size: 0.45rem; /* 12px (từ 14px) */
        font-weight: 700;
        color: #374151;
        margin-bottom: 0.25rem;
      }
      .info-input {
        width: 100%;
        /* === THAY ĐỔI: Giảm padding input === */
        padding-left: 0.2rem; /* 8px */
        padding-right: 0.2rem; /* 8px */
        padding-top: 0.175rem; /* 6px (từ 8px) */
        padding-bottom: 0.275rem; /* 6px (từ 8px) */
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
        box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        /* === THAY ĐỔI: Giảm cỡ chữ input === */
        font-size: 0.4125rem; /* 13px (từ 14px) */
        color: #1e40af;
        font-weight: 500;
      }
      .info-input:focus {
        outline: none;
        box-shadow: 0 0 0 2px #22c55e;
        border-color: #22c55e;
      }
      .info-value {
        /* === THAY ĐỔI: Giảm cỡ chữ kết quả quét === */
        font-size: 0.5rem; /* 16px (từ 18px) */
        font-weight: 600;
        color: #111827;
      }
    </style>
  </head>
  <body class="bg-gray-100">
    <div id="scanner-panel">
      <button
        onclick="window.location.href='index.html'"
        class="w-full bg-gray-600 text-white font-bold py-2 px-3 text-sm rounded-lg hover:bg-gray-700 transition-all mb-3"
      >
        Quay lại Trang Chủ
      </button>

      <h1 class="text-xl font-bold text-center text-green-700 mb-3">
        Quản Lý Cây Trồng
      </h1>

      <div id="scanner-section">
        <div
          id="scanner-container"
          class="mb-3 w-full border-2 border-gray-300 rounded-lg overflow-hidden"
          style="min-height: 200px"
        ></div>
        <button
          id="btn-start-scan"
          class="w-full bg-green-600 text-white font-bold py-2 px-3 text-sm rounded-lg hover:bg-green-700 transition-all"
        >
          Bắt Đầu Quét
        </button>
      </div>

      <div id="result-section" class="hidden">
        <div id="loading-spinner" class="text-center my-3 hidden">
          <div class="text-blue-600 font-medium">Đang tìm kiếm...</div>
        </div>

        <div
          id="error-message"
          class="text-center my-3 p-2 bg-red-100 text-red-700 rounded-lg hidden"
        ></div>

        <div id="result-container" class="space-y-3">
          <div>
            <div class="info-label">Mã Vạch Đã Quét</div>
            <div id="result-id" class="info-value text-blue-600"></div>
          </div>
          <hr />
          <div>
            <label class="info-label" for="result-ma-cay">Mã Cây</label>
            <input
              type="text"
              id="result-ma-cay"
              class="info-input bg-gray-100"
              readonly
            />
          </div>
          <div>
            <label class="info-label" for="result-ten">Tên Thường Gọi</label>
            <input type="text" id="result-ten" class="info-input" />
          </div>
          <div>
            <label class="info-label" for="result-ten-khoa-hoc"
              >Tên Khoa Học</label
            >
            <input type="text" id="result-ten-khoa-hoc" class="info-input" />
          </div>
          <div>
            <label class="info-label" for="result-tinh-trang"
              >Tình Trạng Sức Khỏe</label
            >
            <select id="result-tinh-trang" class="info-input">
              <option value="Tốt">Tốt</option>
              <option value="Trung Bình">Trung Bình</option>
              <option value="Kém">Kém</option>
            </select>
          </div>
          <div>
            <label class="info-label" for="result-vi-tri"
              >Vị Trí (Lat, Long)</label
            >
            <input
              type="text"
              id="result-vi-tri"
              class="info-input"
              placeholder="Ví dụ: 01/10/0279, 1057686"
            />
          </div>
          <div>
            <label class="info-label" for="result-ngay-trong">Ngày Trồng</label>
            <input
              type="text"
              id="result-ngay-trong"
              class="info-input"
              placeholder="Ví dụ: 15/01/2023"
            />
          </div>
        </div>

        <div
          id="save-status"
          class="text-center my-3 p-2 rounded-lg hidden"
        ></div>

        <div class="flex gap-4 mt-4">
          <button
            id="btn-scan-again"
            class="w-1/2 bg-gray-600 text-white font-bold py-2 px-3 text-sm rounded-lg hover:bg-gray-700 transition-all"
          >
            Quét Lại
          </button>
          <button
            id="btn-save"
            class="w-1/2 bg-blue-600 text-white font-bold py-2 px-3 text-sm rounded-lg hover:bg-blue-700 transition-all"
          >
            Lưu Thay Đổi
          </button>
        </div>
      </div>
    </div>
    <div id="map-container">
      <div id="map"></div>
    </div>
    <script>
      // --- PHẦN 1: KHỞI TẠO BẢN ĐỒ ---
      const map = L.map("map", {
        center: [10.122241670031254, 105.91019045369704],
        zoom: 22,
        minZoom: 15,
        maxZoom: 22,
      });

      // *** DÙNG URL MAPTILER CỦA BẠN ***
      L.tileLayer(
        "https://api.maptiler.com/tiles/019a39b4-4745-700c-b991-07dc74d49321/{z}/{x}/{y}.png?key=SUK1Kacu0nBmruoAMGBy",
        {
          maxZoom: 22,
          minZoom: 15,
          attribution: "Bản đồ © TamNhaFarm | MapTiler",
          // BỎ tms: true
        }
      ).addTo(map);

      // --- PHẦN 2: KHAI BÁO BIẾN ---
      const GAS_WEB_APP_URL =
        "https://script.google.com/macros/s/AKfycbwCTzffRpPrWjaLXzh5lme9C1KoPiY4wII3uLYvMspiDcC5j8b7betKz0Lhv827N0D06g/exec";
      const html5QrCode = new Html5Qrcode("scanner-container");
      const scannerSection = document.getElementById("scanner-section");
      const resultSection = document.getElementById("result-section");
      const btnStartScan = document.getElementById("btn-start-scan");
      const btnScanAgain = document.getElementById("btn-scan-again");
      const btnSave = document.getElementById("btn-save");
      const loadingSpinner = document.getElementById("loading-spinner");
      const errorMessage = document.getElementById("error-message");
      const saveStatus = document.getElementById("save-status");
      const resultContainer = document.getElementById("result-container");
      const resultId = document.getElementById("result-id");
      const resultMaCay = document.getElementById("result-ma-cay");
      const resultTen = document.getElementById("result-ten");
      const resultTenKhoaHoc = document.getElementById("result-ten-khoa-hoc");
      const resultTinhTrang = document.getElementById("result-tinh-trang");
      const resultViTri = document.getElementById("result-vi-tri");
      const resultNgayTrong = document.getElementById("result-ngay-trong");

      // --- PHẦN 3: HÀM ĐIỀU KHIỂN SCANNER ---
      function startScanner() {
        const config = { fps: 10, qrbox: { width: 250, height: 250 } };
        html5QrCode
          .start(
            { facingMode: "environment" },
            config,
            onScanSuccess,
            onScanFailure
          )
          .catch((err) => {
            console.error("Không thể khởi động camera", err);
            showError("Không thể khởi động camera. Vui lòng cấp quyền.");
            btnStartScan.classList.remove("hidden");
          });
      }

      const onScanSuccess = (decodedText, decodedResult) => {
        console.log(`Scan result: ${decodedText}`);
        html5QrCode
          .stop()
          .catch((err) => console.warn("Error stopping scanner:", err));
        scannerSection.classList.add("hidden");
        resultSection.classList.remove("hidden");
        resultContainer.classList.add("hidden");
        errorMessage.classList.add("hidden");
        saveStatus.classList.add("hidden");
        loadingSpinner.classList.remove("hidden");
        resultId.innerText = decodedText;
        fetchPlantData(decodedText);
      };

      const onScanFailure = (error) => {
        // console.warn(`Scan error: ${error}`);
      };

      // --- PHẦN 4: HÀM XỬ LÝ DỮ LIỆU ---
      async function fetchPlantData(plantId) {
        const url = `${GAS_WEB_APP_URL}?id=${encodeURIComponent(plantId)}`;
        try {
          const response = await fetch(url);
          const data = await response.json();
          loadingSpinner.classList.add("hidden");
          if (data.success) {
            const plant = data.plantData;
            resultMaCay.value = plant.maCay;
            resultTen.value = plant.tenThuongGoi;
            resultTenKhoaHoc.value = plant.tenKhoaHoc;
            resultTinhTrang.value = plant.tinhTrang;
            resultViTri.value = plant.viTri;
            resultNgayTrong.value = plant.ngayTrong;
            resultContainer.classList.remove("hidden");
            zoomToPlantLocation(plant.viTri);
          } else {
            showError(`Không tìm thấy cây với Mã: ${plantId}`);
          }
        } catch (error) {
          console.error("Fetch Error:", error);
          loadingSpinner.classList.add("hidden");
          showError("Lỗi kết nối (GET). Vui lòng thử lại.");
        }
      }

      async function savePlantData() {
        saveStatus.classList.remove(
          "hidden",
          "bg-red-100",
          "text-red-700",
          "bg-green-100",
          "text-green-700"
        );
        saveStatus.classList.add("bg-blue-100", "text-blue-700");
        saveStatus.innerText = "Đang lưu...";
        const plantDataToSave = {
          maCay: resultMaCay.value,
          tenThuongGoi: resultTen.value,
          tenKhoaHoc: resultTenKhoaHoc.value,
          tinhTrang: resultTinhTrang.value,
          viTri: resultViTri.value,
          ngayTrong: resultNgayTrong.value,
        };
        try {
          const response = await fetch(GAS_WEB_APP_URL, {
            method: "POST",
            mode: "cors",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ action: "update", data: plantDataToSave }),
          });
          const result = await response.json();
          if (result.success) {
            saveStatus.classList.remove("bg-blue-100", "text-blue-700");
            saveStatus.classList.add("bg-green-100", "text-green-700");
            saveStatus.innerText = result.message;
          } else {
            showSaveError(result.message);
          }
        } catch (error) {
          console.error("Save Error:", error);
          showSaveError("Lỗi kết nối (POST). Không thể lưu.");
        }
      }

      // --- PHẦN 5: HÀM HIỂN THỊ ---
      function zoomToPlantLocation(viTri) {
        try {
          const [latStr, longStr] = viTri.split(",").map((s) => s.trim());
          const latClean = latStr.replace("01/", "").replace("/", ".");
          const lat = parseFloat(latClean);
          const long = parseFloat(longStr.slice(0, 3) + "." + longStr.slice(3));
          if (!isNaN(lat) && !isNaN(long)) {
            map.setView([lat, long], 22);
            L.marker([lat, long])
              .addTo(map)
              .bindPopup("Vị trí cây")
              .openPopup();
          } else {
            console.error("Tọa độ không hợp lệ:", viTri);
            alert("Tọa độ trong dữ liệu không hợp lệ.");
          }
        } catch (e) {
          console.error("Lỗi xử lý tọa độ:", e);
          alert("Dữ liệu vị trí bị lỗi, không thể zoom.");
        }
      }

      function showError(message) {
        errorMessage.innerText = message;
        errorMessage.classList.remove("hidden");
      }

      function showSaveError(message) {
        saveStatus.classList.remove("bg-blue-100", "text-blue-700");
        saveStatus.classList.add("bg-red-100", "text-red-700");
        saveStatus.innerText = message;
      }

      // --- PHẦN 6: GÁN SỰ KIỆN CHO CÁC NÚT ---
      btnStartScan.addEventListener("click", () => {
        btnStartScan.classList.add("hidden");
        startScanner();
      });

      btnScanAgain.addEventListener("click", () => {
        resultSection.classList.add("hidden");
        scannerSection.classList.remove("hidden");
        btnStartScan.classList.add("hidden");
        resultContainer.classList.add("hidden");
        errorMessage.classList.add("hidden");
        saveStatus.classList.add("hidden");
        startScanner();
      });

      btnSave.addEventListener("click", savePlantData);
    </script>
  </body>
</html>
